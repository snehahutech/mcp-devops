name: Build & Deploy MCP Server

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Install Python for build
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Build step (pip install)
      run: |
        cd mcpp-main/mcp-server-actual
        pip install -r requirements.txt

    - name: Install Ansible
      run: |
        sudo apt update
        sudo apt install -y ansible

    - name: Install Ansible Docker collection
      run: ansible-galaxy collection install community.docker


    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2

    - name: Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: Terraform Apply (build docker image & run container)
      working-directory: ./terraform
      run: terraform apply -auto-approve

    # üìå Run Ansible AFTER Terraform, to configure container
    - name: Run Ansible configuration (post-deploy)
      working-directory: ./ansible
      run: ansible-playbook deploy.yml

    # üîç DEBUGGING STEPS
    - name: List Docker containers
      run: docker ps -a

    - name: Inspect container
      run: docker inspect mcp-server || true

    - name: Exec inside container to list files
      run: docker exec mcp-server ls -R /app || true

    - name: Print Docker container logs
      run: docker logs mcp-server || true

    - name: Test MCP server inside container
      run: docker exec mcp-server curl -v http://localhost:8000/health || true
