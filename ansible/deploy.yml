---
- hosts: localhost
  become: yes

  tasks:

    - name: Ensure Docker service is running
      service:
        name: docker
        state: started
        enabled: yes

    - name: Install Python Docker SDK for Ansible
      pip:
        name: docker
        state: present

    - name: Create MCP config directory
      file:
        path: /opt/mcp
        state: directory

    - name: Write .env file for MCP server
      copy:
        dest: /opt/mcp/.env
        content: |
          ENVIRONMENT=production
          LOG_LEVEL=info
          PORT=8000
      notify: Restart MCP Container

    - name: Wait for MCP server to start
      uri:
        url: http://localhost:8000/health
        method: GET
        return_content: yes
      register: healthcheck
      retries: 5
      delay: 3
      until: healthcheck.status == 200

    - debug:
        msg: "MCP Server is healthy: {{ healthcheck.content }}"

  handlers:
    - name: Restart MCP Container
      community.docker.docker_container:
        name: mcp-server
        restart: yes
